# 3.2.3 Sequence Diagram

## Main User Authentication Flow

```mermaid
sequenceDiagram
    participant User
    participant Login
    participant Firebase
    participant Firestore
    participant Home

    User->>Login: 접속
    Login->>User: 로그인 화면 표시
    
    alt Google OAuth 로그인
        User->>Login: Google 로그인 클릭
        Login->>Firebase: Google OAuth 요청
        Firebase->>Login: 사용자 정보 반환
        Login->>Firestore: 사용자 프로필 확인
        alt 프로필 미설정
            Firestore->>Login: 프로필 없음
            Login->>User: 프로필 설정 페이지로 이동
        else 프로필 설정됨
            Firestore->>Login: 프로필 정보 반환
            Login->>Home: 홈 페이지로 이동
        end
    else Kakao OAuth 로그인
        User->>Login: Kakao 로그인 클릭
        Login->>Firebase: Kakao 토큰으로 인증
        Firebase->>Login: 사용자 정보 반환
        Login->>Firestore: 사용자 프로필 확인
        Firestore->>Login: 프로필 정보 반환
        Login->>Home: 홈 페이지로 이동
    end
```

## Outfit Recording Flow

```mermaid
sequenceDiagram
    participant User
    participant Record
    participant WeatherAPI
    participant RecordForm
    participant Firebase
    participant Firestore

    User->>Record: 코디 기록 페이지 접속
    Record->>User: 기록 폼 표시
    
    User->>RecordForm: 지역 선택
    RecordForm->>WeatherAPI: 해당 지역 날씨 정보 요청
    WeatherAPI->>RecordForm: 날씨 데이터 반환
    RecordForm->>User: 날씨 정보 표시
    
    User->>RecordForm: 온도, 습도, 강수량 입력
    User->>RecordForm: 체감 선택
    User->>RecordForm: 날씨 이모지 선택
    
    User->>RecordForm: 코디 사진 업로드
    RecordForm->>Firebase: 이미지 Storage 업로드
    Firebase->>RecordForm: 이미지 URL 반환
    
    User->>RecordForm: 코디 상세 정보 입력
    Note over RecordForm: 아우터, 상의, 하의, 신발, 액세서리
    
    User->>RecordForm: 피드백 입력
    User->>RecordForm: 공개 여부 설정
    
    User->>RecordForm: 저장 버튼 클릭
    RecordForm->>Firestore: 코디 기록 저장
    Firestore->>RecordForm: 저장 완료 확인
    RecordForm->>User: 저장 성공 메시지
    RecordForm->>User: 홈 페이지로 이동
```

## Feed Browsing and Interaction Flow

```mermaid
sequenceDiagram
    participant User
    participant Feed
    participant Firestore
    participant FeedCard
    participant Firebase

    User->>Feed: 피드 페이지 접속
    Feed->>Firestore: 공개된 코디 기록 조회
    Firestore->>Feed: 코디 기록 목록 반환
    Feed->>User: 코디 카드 그리드 표시
    
    User->>Feed: 필터 설정 (지역, 정렬)
    Feed->>Firestore: 필터링된 기록 조회
    Firestore->>Feed: 필터링된 결과 반환
    Feed->>User: 업데이트된 카드 표시
    
    User->>FeedCard: 특정 코디 카드 클릭
    FeedCard->>User: 코디 상세 페이지로 이동
    
    User->>FeedCard: 좋아요 버튼 클릭
    alt 좋아요 추가
        FeedCard->>Firebase: 좋아요 추가
        Firebase->>Firestore: 좋아요 수 업데이트
        Firestore->>FeedCard: 업데이트된 좋아요 수 반환
        FeedCard->>User: 좋아요 상태 변경 표시
    else 좋아요 취소
        FeedCard->>Firebase: 좋아요 제거
        Firebase->>Firestore: 좋아요 수 감소
        Firestore->>FeedCard: 업데이트된 좋아요 수 반환
        FeedCard->>User: 좋아요 상태 변경 표시
    end
```

## Outfit Recommendation Flow

```mermaid
sequenceDiagram
    participant User
    participant Recommend
    participant Firestore
    participant FilterPanel
    participant ResultPanel

    User->>Recommend: 추천 코디 페이지 접속
    Recommend->>Firestore: 최근 30일 기록 조회
    Firestore->>Recommend: 코디 기록 목록 반환
    Recommend->>User: 빈 결과 화면 표시 (필터 필요)
    
    User->>FilterPanel: 지역 선택
    FilterPanel->>Recommend: 지역 필터 업데이트
    Recommend->>Firestore: 지역별 기록 조회
    Firestore->>Recommend: 지역별 결과 반환
    
    User->>FilterPanel: 온도 범위 설정
    FilterPanel->>Recommend: 온도 필터 업데이트
    Recommend->>Recommend: 로컬 필터링 적용
    
    User->>FilterPanel: 강수량 범위 설정
    FilterPanel->>Recommend: 강수량 필터 업데이트
    Recommend->>Recommend: 로컬 필터링 적용
    
    User->>FilterPanel: 습도 범위 설정
    FilterPanel->>Recommend: 습도 필터 업데이트
    Recommend->>Recommend: 로컬 필터링 적용
    
    User->>FilterPanel: 체감 선택
    FilterPanel->>Recommend: 체감 필터 업데이트
    Recommend->>Recommend: 로컬 필터링 적용
    
    User->>FilterPanel: 날씨 이모지 선택
    FilterPanel->>Recommend: 이모지 필터 업데이트
    Recommend->>Recommend: 로컬 필터링 적용
    
    Recommend->>Recommend: 필터링된 결과 정렬 (좋아요 순)
    Recommend->>ResultPanel: 필터링된 결과 전달
    ResultPanel->>User: 추천 코디 카드 표시
    
    User->>ResultPanel: 특정 코디 선택
    ResultPanel->>User: 코디 상세 페이지로 이동
```

## Weather Data Integration Flow

```mermaid
sequenceDiagram
    participant User
    participant Home
    participant KMAWeather
    participant RegionGrid
    participant KMAAPI
    participant WeatherCard

    User->>Home: 홈 페이지 접속
    Home->>Home: 사용자 지역 확인
    
    alt 사용자 지역 설정됨
        Home->>KMAWeather: 해당 지역 날씨 정보 요청
        KMAWeather->>RegionGrid: 지역별 격자 좌표 조회
        RegionGrid->>KMAWeather: nx, ny 좌표 반환
        
        KMAWeather->>KMAWeather: 현재 시간 기준 날짜/시간 계산
        KMAWeather->>KMAAPI: 기상청 단기예보 API 호출
        
        alt API 호출 성공
            KMAAPI->>KMAWeather: 날씨 데이터 반환
            KMAWeather->>KMAWeather: 데이터 파싱 및 가공
            KMAWeather->>Home: 파싱된 날씨 정보 반환
        else API 호출 실패
            KMAWeather->>KMAWeather: 모의 데이터 생성
            KMAWeather->>Home: 모의 날씨 정보 반환
        end
        
        Home->>WeatherCard: 날씨 정보 전달
        WeatherCard->>User: 날씨 카드 표시
        
    else 사용자 지역 미설정
        Home->>User: 지역 설정 안내 메시지
    end
```

## Image Upload and Storage Flow

```mermaid
sequenceDiagram
    participant User
    participant RecordForm
    participant FileInput
    participant Firebase
    participant Storage
    participant Firestore

    User->>RecordForm: 이미지 선택 버튼 클릭
    RecordForm->>FileInput: 파일 선택 다이얼로그 열기
    User->>FileInput: 이미지 파일 선택
    FileInput->>RecordForm: 선택된 파일 정보 전달
    
    RecordForm->>RecordForm: 파일 유효성 검사
    alt 파일 유효
        RecordForm->>RecordForm: 이미지 미리보기 생성
        RecordForm->>User: 미리보기 이미지 표시
        
        User->>RecordForm: 저장 버튼 클릭
        RecordForm->>Firebase: Firebase Storage 참조 생성
        
        loop 각 이미지 파일
            RecordForm->>Storage: 이미지 파일 업로드
            Storage->>RecordForm: 업로드 진행률 반환
            RecordForm->>User: 업로드 진행률 표시
            Storage->>RecordForm: 업로드 완료 및 URL 반환
        end
        
        RecordForm->>RecordForm: 모든 이미지 URL 수집
        RecordForm->>Firestore: 코디 기록과 함께 이미지 URL 저장
        Firestore->>RecordForm: 저장 완료 확인
        RecordForm->>User: 저장 성공 메시지
        
    else 파일 무효
        RecordForm->>User: 파일 형식 오류 메시지
    end
```

## User Profile Management Flow

```mermaid
sequenceDiagram
    participant User
    participant MyPage
    participant ProfileEdit
    participant Firestore
    participant Auth

    User->>MyPage: 마이페이지 접속
    MyPage->>Firestore: 사용자 프로필 정보 조회
    Firestore->>MyPage: 프로필 정보 반환
    MyPage->>User: 프로필 정보 표시
    
    User->>MyPage: 프로필 편집 버튼 클릭
    MyPage->>ProfileEdit: 프로필 편집 페이지로 이동
    ProfileEdit->>User: 편집 폼 표시 (기존 정보 미리 입력)
    
    User->>ProfileEdit: 프로필 정보 수정
    ProfileEdit->>ProfileEdit: 입력값 유효성 검사
    
    User->>ProfileEdit: 저장 버튼 클릭
    ProfileEdit->>Firestore: 프로필 정보 업데이트
    Firestore->>ProfileEdit: 업데이트 완료 확인
    ProfileEdit->>User: 저장 성공 메시지
    ProfileEdit->>User: 마이페이지로 돌아가기
    
    User->>MyPage: 마이페이지 새로고침
    MyPage->>Firestore: 업데이트된 프로필 정보 조회
    Firestore->>MyPage: 최신 프로필 정보 반환
    MyPage->>User: 업데이트된 프로필 정보 표시
```

## Comment and Interaction Flow

```mermaid
sequenceDiagram
    participant User
    participant FeedDetail
    participant CommentForm
    participant Firestore
    participant CommentList

    User->>FeedDetail: 코디 상세 페이지 접속
    FeedDetail->>Firestore: 코디 기록 및 댓글 조회
    Firestore->>FeedDetail: 데이터 반환
    FeedDetail->>User: 코디 상세 및 댓글 목록 표시
    
    User->>CommentForm: 댓글 입력
    CommentForm->>CommentForm: 입력값 유효성 검사
    
    User->>CommentForm: 댓글 작성 버튼 클릭
    CommentForm->>Firestore: 새 댓글 저장
    Firestore->>CommentForm: 저장 완료 확인
    
    CommentForm->>FeedDetail: 댓글 목록 새로고침
    FeedDetail->>Firestore: 업데이트된 댓글 목록 조회
    Firestore->>FeedDetail: 최신 댓글 목록 반환
    FeedDetail->>CommentList: 댓글 목록 업데이트
    CommentList->>User: 새 댓글 포함된 목록 표시
    
    User->>CommentList: 특정 댓글 좋아요 클릭
    CommentList->>Firebase: 댓글 좋아요 토글
    Firebase->>Firestore: 좋아요 상태 업데이트
    Firestore->>CommentList: 업데이트된 좋아요 상태 반환
    CommentList->>User: 좋아요 상태 변경 표시
```

## Calendar and Date-based Navigation Flow

```mermaid
sequenceDiagram
    participant User
    participant Calendar
    participant CalendarComponent
    participant Firestore
    participant DatePicker

    User->>Calendar: 캘린더 페이지 접속
    Calendar->>Firestore: 사용자 코디 기록 조회
    Firestore->>Calendar: 기록 목록 반환
    Calendar->>User: 캘린더 화면 표시
    
    User->>CalendarComponent: 특정 날짜 클릭
    CalendarComponent->>Calendar: 선택된 날짜 정보 전달
    Calendar->>Calendar: 해당 날짜의 기록 필터링
    
    alt 해당 날짜에 기록 존재
        Calendar->>User: 날짜별 코디 목록 표시
        User->>Calendar: 특정 코디 선택
        Calendar->>User: 코디 상세 페이지로 이동
    else 해당 날짜에 기록 없음
        Calendar->>User: "해당 날짜에 기록이 없습니다" 메시지
    end
    
    User->>DatePicker: 다른 날짜 선택
    DatePicker->>Calendar: 새로운 날짜 정보 전달
    Calendar->>Calendar: 새 날짜의 기록 필터링
    Calendar->>User: 업데이트된 날짜별 코디 목록 표시
```

## Error Handling and Fallback Flow

```mermaid
sequenceDiagram
    participant User
    participant App
    participant Component
    participant API
    participant Fallback

    User->>App: 앱 사용
    App->>Component: 컴포넌트 렌더링
    
    Component->>API: 데이터 요청
    
    alt API 응답 성공
        API->>Component: 정상 데이터 반환
        Component->>User: 정상 화면 표시
        
    else API 응답 실패
        API->>Component: 에러 응답
        Component->>Component: 에러 상태 설정
        
        alt 네트워크 에러
            Component->>Fallback: 오프라인 모드 활성화
            Fallback->>Component: 캐시된 데이터 반환
            Component->>User: 캐시된 데이터로 화면 표시
            
        else 인증 에러
            Component->>App: 로그인 페이지로 리다이렉트
            App->>User: 로그인 화면 표시
            
        else 서버 에러
            Component->>User: "일시적인 오류가 발생했습니다" 메시지
            Component->>User: 재시도 버튼 표시
            
        else 데이터 없음
            Component->>User: "데이터가 없습니다" 메시지
            Component->>User: 빈 상태 화면 표시
        end
    end
    
    User->>Component: 재시도 버튼 클릭
    Component->>API: 데이터 재요청
    API->>Component: 정상 데이터 반환
    Component->>User: 정상 화면 표시
```


