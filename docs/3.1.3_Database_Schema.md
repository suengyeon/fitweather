# 3.1.3 Database Schema (Structures)

## Firestore Collections Overview

### 1. Users Collection
```javascript
Collection: users
Document ID: {uid} (Firebase Auth UID)

{
  uid: string,                    // Firebase Auth UID
  email: string,                  // 사용자 이메일
  displayName: string,            // 사용자 이름
  photoURL: string,               // 프로필 사진 URL
  createdAt: timestamp,           // 계정 생성 시간
  updatedAt: timestamp,           // 정보 수정 시간
  
  // 프로필 정보
  profile: {
    nickname: string,             // 닉네임
    age: number,                  // 나이
    gender: string,               // 성별 (male/female)
    height: number,               // 키 (cm)
    weight: number,               // 몸무게 (kg)
    style: string[],              // 선호 스타일 배열
    region: string                // 주 활동 지역
  },
  
  // 설정 정보
  settings: {
    isPublic: boolean,            // 공개 프로필 여부
    notifications: boolean,        // 알림 수신 여부
    language: string              // 언어 설정
  }
}
```

### 2. OutfitRecords Collection
```javascript
Collection: outfitRecords
Document ID: {auto-generated}

{
  id: string,                     // 문서 ID
  uid: string,                    // 작성자 UID (users 컬렉션 참조)
  region: string,                 // 지역 (Seoul, Busan, etc.)
  date: timestamp,                // 기록 날짜
  createdAt: timestamp,           // 생성 시간
  updatedAt: timestamp,           // 수정 시간
  
  // 날씨 정보
  weather: {
    temp: number,                 // 온도 (°C)
    rain: number,                 // 강수량 (mm)
    humidity: number,             // 습도 (%)
    sky: string,                  // 하늘 상태
    icon: string                  // 날씨 아이콘
  },
  
  // 체감 정보
  feeling: string,                // 체감 (steam, hot, nice, cold, ice)
  weatherEmojis: string[],        // 날씨 이모지 배열
  
  // 코디 정보
  outfit: {
    outer: string[],              // 아우터 (자켓, 코트 등)
    top: string[],                // 상의 (티셔츠, 니트 등)
    bottom: string[],             // 하의 (청바지, 스커트 등)
    shoes: string[],              // 신발 (운동화, 구두 등)
    acc: string[]                 // 액세서리 (모자, 가방 등)
  },
  
  // 이미지 정보
  imageUrls: string[],            // 이미지 URL 배열
  thumbnailUrl: string,           // 썸네일 URL
  
  // 메타데이터
  isPublic: boolean,              // 공개 여부
  likes: string[],                // 좋아요한 사용자 UID 배열
  likeCount: number,              // 좋아요 수
  commentCount: number,           // 댓글 수
  
  // 추가 정보
  feedback: string,               // 사용자 피드백
  tags: string[],                 // 태그 배열
  season: string                  // 계절 정보
}
```

### 3. Likes Collection
```javascript
Collection: likes
Document ID: {auto-generated}

{
  id: string,                     // 문서 ID
  recordId: string,               // outfitRecords 문서 ID 참조
  uid: string,                    // 좋아요한 사용자 UID
  createdAt: timestamp,           // 좋아요 시간
  
  // 참조 정보
  recordRef: DocumentReference,   // outfitRecords 문서 참조
  userRef: DocumentReference      // users 문서 참조
}
```

### 4. Comments Collection
```javascript
Collection: comments
Document ID: {auto-generated}

{
  id: string,                     // 문서 ID
  recordId: string,               // outfitRecords 문서 ID 참조
  uid: string,                    // 댓글 작성자 UID
  content: string,                // 댓글 내용
  createdAt: timestamp,           // 작성 시간
  updatedAt: timestamp,           // 수정 시간
  
  // 참조 정보
  recordRef: DocumentReference,   // outfitRecords 문서 참조
  userRef: DocumentReference      // users 문서 참조
  
  // 댓글 메타데이터
  isEdited: boolean,              // 수정 여부
  likes: string[]                 // 댓글 좋아요 UID 배열
}
```

### 5. WeatherData Collection
```javascript
Collection: weatherData
Document ID: {region}_{date}

{
  id: string,                     // 문서 ID (지역_날짜)
  region: string,                 // 지역명
  date: string,                   // 날짜 (YYYYMMDD)
  baseTime: string,               // 기준 시간 (HHMM)
  
  // 날씨 데이터
  forecast: [
    {
      category: string,           // 데이터 종류 (TMP, RN1, REH, SKY)
      fcstTime: string,           // 예보 시간 (HHMM)
      fcstValue: string,          // 예보 값
      fcstDate: string            // 예보 날짜
    }
  ],
  
  // 캐시 정보
  cachedAt: timestamp,            // 캐시 시간
  expiresAt: timestamp            // 만료 시간
}
```

## Database Relationships

### One-to-Many Relationships
```
Users (1) ←→ (Many) OutfitRecords
Users (1) ←→ (Many) Likes
Users (1) ←→ (Many) Comments
OutfitRecords (1) ←→ (Many) Likes
OutfitRecords (1) ←→ (Many) Comments
```

### Indexes
```javascript
// outfitRecords 컬렉션 인덱스
{
  region: Ascending,
  date: Descending,
  uid: Ascending,
  isPublic: Ascending,
  createdAt: Descending
}

// likes 컬렉션 인덱스
{
  recordId: Ascending,
  uid: Ascending,
  createdAt: Descending
}

// comments 컬렉션 인덱스
{
  recordId: Ascending,
  createdAt: Ascending
}
```

## Security Rules

### Firestore Security Rules
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 사용자 문서
    match /users/{userId} {
      allow read: if request.auth != null && 
        (request.auth.uid == userId || resource.data.settings.isPublic == true);
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 코디 기록
    match /outfitRecords/{recordId} {
      allow read: if request.auth != null && 
        (resource.data.isPublic == true || resource.data.uid == request.auth.uid);
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.uid;
      allow update, delete: if request.auth != null && 
        resource.data.uid == request.auth.uid;
    }
    
    // 좋아요
    match /likes/{likeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        request.auth.uid == request.resource.data.uid;
    }
    
    // 댓글
    match /comments/{commentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.uid;
      allow update, delete: if request.auth != null && 
        resource.data.uid == request.auth.uid;
    }
  }
}
```

## Data Validation

### OutfitRecord Validation
```javascript
// 필수 필드 검증
const requiredFields = ['uid', 'region', 'date', 'outfit', 'imageUrls'];

// 데이터 타입 검증
const validateOutfitRecord = (data) => {
  if (typeof data.uid !== 'string') throw new Error('uid must be string');
  if (typeof data.region !== 'string') throw new Error('region must be string');
  if (!(data.date instanceof Date)) throw new Error('date must be Date object');
  if (!Array.isArray(data.outfit.top)) throw new Error('outfit.top must be array');
  if (!Array.isArray(data.imageUrls)) throw new Error('imageUrls must be array');
  
  return true;
};
```


